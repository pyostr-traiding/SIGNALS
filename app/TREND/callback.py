"""
{
  "trend": {
    "current": "down",                    // Текущий тренд: направление рынка ("up" - вверх, "down" - вниз, "flat" - боковик)
    "confidence": 0.8075,                 // Уверенность модели в текущем тренде (0-1, где 1 = полная уверенность)
    "next": {                              // Вероятности перехода в следующий тренд
      "down": 0.00826,                     // Вероятность, что следующий тренд будет вниз
      "flat": 0.99174,                     // Вероятность бокового движения
      "up": 0.000000031                     // Вероятность разворота вверх
    },
    "state": 1                             // Номер состояния HMM, соответствующий текущему тренду
  },
  "accumulation": {
    "current": 91417.5,                    // Текущая цена закрытия
    "low": 91321.5,                        // Минимум цены за окно накопления
    "high": 92322.4,                       // Максимум цены за окно накопления
    "avg_range": 11.086,                    // Средний диапазон свечей в окне накопления (high-low)
    "volume": 109.428,                      // Суммарный объём за окно накопления
    "signal": "внутри диапазона накопления", // Сигнал по позиции цены внутри зоны (нижняя, верхняя, пробой)
    "potential_move": 11.086,               // Потенциальное движение цены, рассчитанное по диапазону
    "direction": null                        // Направление возможного движения (up/down), если оно очевидно
  },
  "radius": "short_only",                  // Интегральный сигнал направления: открывать позиции только вниз
  "radius_value": 16.62931,                // Потенциальное расстояние движения цены в рамках RADIUS (числовое)
  "meta": {                                // Signal pack — все данные для других сервисов
    "bias": "short",                        // Направление bias для торговли ("long"/"short")
    "bias_confidence": 0.8075,              // Уверенность в bias
    "action": "prepare_short",              // Рекомендованное действие на основе тренда и накопления
    "action_reason": "trend down with low reversal risk", // Почему выбран этот action
    "radius_mode": "short_only",            // Словесное представление RADIUS
    "radius_value": 16.62931,               // Числовой RADIUS
    "trend_strength": 0.8075,               // Сила текущего тренда (по уверенности HMM)
    "reversal_risk": 0.0,                   // Вероятность разворота против текущего тренда
    "acc_signal": "внутри диапазона накопления", // Сигнал зоны накопления
    "acc_low": 91321.5,                     // Минимум накопления (для meta)
    "acc_high": 92322.4,                    // Максимум накопления
    "acc_avg_range": 11.086                 // Средний диапазон накопления
  },
  "kline_ms": 1764347160000,               // Временная метка последней свечи (ms)
  "interval": 1                             // Таймфрейм свечи (в минутах, секундах или как задано)
}
"""

import os
from pprint import pprint

from klines.kline import Klines
from klines.schema.kline import KlineSchema



def trend_callback(klines: Klines, kline: KlineSchema):
    if klines.interval != 1:
        return

    rev = klines.get_current_trend(window=30)
